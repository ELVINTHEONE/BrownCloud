{% extends "layout.html" %}

{% block body %}
<div>
        <div style="display:block">
                <object height="81" width="100%" id="myPlayer" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000">
                        <param name="movie" value="http://player.soundcloud.com/player.swf?url=http%3A%2F%2Fsoundcloud.com%2Fmatas%2Fhobnotropic&enable_api=true&object_id=myPlayer"></param>
                        <param name="allowscriptaccess" value="always"></param>
                        <embed allowscriptaccess="always" height="81" src="http://player.soundcloud.com/player.swf?url=http%3A%2F%2Fsoundcloud.com%2Fmatas%2Fhobnotropic&enable_api=true&object_id=myPlayer" type="application/x-shockwave-flash" width="100%" name="myPlayer"></embed>
                </object>
        </div>
        <div style="display:block">
                <h3>Search for something</h3>
                <div class="searched_tracks" style="float: left; width: 50%;">
                        <input type="text" id="track_search" placeholder="Search for tracks"/>
                        <ul id="fetched_tracks">
                        </ul>
                </div>
                <div class="searched_playlists" style="float: right; width:50%">
                        <input type="text" id="playlist_search" placeholder="Search for playlists"/>
                        <ul id="fetched_playlists">
                        </ul>
                </div>
        </div>
</div>
{% endblock %}

{% block scripts %}
<!--<script type="text/javascript" src="//w.soundcloud.com/player/api.js"></script>-->
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
<script src="//code.jquery.com/ui/1.11.3/jquery-ui.min.js"
        integrity="sha256-xI/qyl9vpwWFOXz7+x/9WkG5j/SVnSw21viy8fWwbeE="
        crossorigin="anonymous"></script><script type="text/javascript" src="//connect.soundcloud.com/sdk/sdk-3.0.0.js"></script>
<script>
        // jQuery extension for a delayed keyup http://stackoverflow.com/a/6054104/747275
        (function($){

                $.widget("ui.onDelayedKeyup", {

                        _init : function() {
                                var self = this;
                                $(this.element).keyup(function() {
                                        if(typeof(window['inputTimeout']) != "undefined"){
                                                window.clearTimeout(inputTimeout);
                                        }
                                        var handler = self.options.handler;
                                        window['inputTimeout'] = window.setTimeout(function() {
                                                handler.call(self.element) }, self.options.delay);
                                });
                        },
                        options: {
                                handler: $.noop(),
                                delay: 500
                        }

                });
        })(jQuery);
</script>
<script>
        function removeLastComma(str) {
                var s = str.trim();
                var ix = s.lastIndexOf(",");
                return s.substring(0, ix);
        }
        function playSound(link) {
                var player = soundcloud.getPlayer('myPlayer');
                player.api_load(link);
                player.api_play();
        }
        // create a list item for a track/playlist
        function createListItem(item) {
                return "<div onclick='playSound(" + item.permalink_url + ")'>" +
                                "<h2>" + item.title + "</h2>" +
                                "<h4" + item.description + "</h4>" +
                                "<p>" +
                                        "<span>" +
                                                "User " +
                                                "<a href='" + item.user.permalink_url + "' target='_blank'>" +
                                                        item.user.username + " " +
                                                        "<img src='"+ item.user.avatar_url + "' alt='" + item.user.username + " avatar '>" +
                                                "</a>" +
                                        "</span><br />" +
                                        "<span>Created: " + item.created_at + "</span><br />" +
                                        "<span>Genre: " + item.genre + "</span><br />" +
                                        "<span>Tags: " + item.tag_list + "</span><br />" +
                                "</p>" +
                        "</div>";
        }
        // tracks and playlists share the same data attributes, so a generic function is OK
        function fetchAndAddToList(url, query, jqueryList) {
                if (query.length > 0) {
                        // reload the tracks based on the query string
                        $.post({
                                url: url, //base_uri + 'tracks'/'playlists'
                                data: JSON.stringify({
                                        'query': query
                                }),
                                success: function(dataFromServer) {
                                        // empty the list
                                        jqueryList.empty();
                                        // add the fetched data
                                        for (var ix = 0; ix < dataFromServer.data.length; ix++) {
                                                var item = dataFromServer.data[ix].obj;
                                                jqueryList.append("<li>" + createListItem(item) + "</li>");
                                        }
                                },
                                contentType:"application/json",
                                dataType: 'json'
                        });
                }
        }
        $(document).ready(function() {
                SC.initialize({
                        client_id: '53e3ccfd305043eb4e01b99b9cf18a37',
                        redirect_uri: 'http://brown-cloud.herokuapp.com/auth_redirect'
                });
                var base_uri = "http://brown-cloud.herokuapp.com/";
                $("#track_search").onDelayedKeyup({
                        handler: function() {
                                fetchAndAddToList(
                                        base_uri + 'tracks',
                                        $.trim($(this).val()), 
                                        $("ul#fetched_tracks")
                                )
                        }
                });
                $("#playlist_search").onDelayedKeyup({
                        handler: function() {
                                fetchAndAddToList(
                                        base_uri + 'playlists',
                                        $.trim($(this).val()),
                                        $("ul#fetched_playlists")
                                )
                        }
                });
        });
</script>
{% endblock %}
